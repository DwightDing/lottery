<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="./css/index.css">
    <script src="./js/data.js"></script>
    <script src="./js/lottery.js"></script>
</head>

<body style="width: 100%; height: 100%;">
<div class="root" id="container">
    <div class="header">
        <img style="width: 60%;" src="./img/title.png">
    </div>

    <div class="container">
        <img class="boy" src="./img/IMG_6236.PNG" />
        <div class="number" id="number">
            <div id="initial" class="number-container">
                <div class="singlenumber">Êé•</div>
                <div class="singlenumber">Â•Ω</div>
                <div class="singlenumber">Ëøê</div>
            </div>
            <div id="lottery" style="display: none;" class="number-container">
                <div class="singlenumber">
                    <div class="number-window" id="number-window-1">
                        <div class="number-list" id="number-list-1">
                            <div class="num">0</div>
                            <div class="num">1</div>
                            <div class="num">2</div>
                            <div class="num">3</div>
                            <div class="num">5</div>
                        </div>
                    </div>
                </div>
                <div class="singlenumber">
                    <div class="number-window" id="number-window-2">
                        <div class="number-list" id="number-list-2">
                            <div class="num">0</div>
                            <div class="num">1</div>
                            <div class="num">2</div>
                            <div class="num">3</div>
                            <div class="num">5</div>
                            <div class="num">6</div>
                            <div class="num">7</div>
                            <div class="num">8</div>
                            <div class="num">9</div>
                        </div>
                    </div>
                </div>
                <div class="singlenumber">
                    <div class="number-window" id="number-window-3">
                        <div class="number-list" id="number-list-3">
                            <div class="num">0</div>
                            <div class="num">1</div>
                            <div class="num">2</div>
                            <div class="num">3</div>
                            <div class="num">5</div>
                            <div class="num">6</div>
                            <div class="num">7</div>
                            <div class="num">8</div>
                            <div class="num">9</div>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
        <img class="girl" src="./img/IMG_6237.PNG" />
    </div>
    <div class="footer">
        <div style="font-size: 6vw;color:#CB0044;text-align: center;font-family: mitao;">‰∏≠Â•ñÂêçÂçï</div>
        <marquee style="width: 100%;font-size: 4vw;color:#CB0044;text-align: center;font-family: mitao;" id="list"></marquee>
    </div>
</div>

    <script>
        window.addEventListener('load', onLoad)
        window.addEventListener('unload', onUnload)
        function onLoad() {
            const container = document.getElementById('container')
            container.addEventListener('mousedown', onMouseDown)
        }
        function onUnload() {
            const container = document.getElementById('container')
            container.removeEventListener('mousedown', onMouseDown)
        }


        /**
         * ÊªöÂä®ÈÄüÂ∫¶ ÂèØË∞É, ÊªöÂÆå‰∏Ä‰∏™Âë®ÊúüÁöÑÊó∂Èó¥ÔºåÊó∂Èó¥Ë∂äÁü≠ÈÄüÂ∫¶Ë∂äÂø´
        */
        const CYCLE_TIME = 0.5 // ‰∏ÄËà¨ÊªöÂä®  0.5s
        const SLOW_CYCLE = 2  // ÁÇπÂáªÂÅúÊ≠¢ÂêéÁöÑÁºìÂÜ≤  2s


        let run = false 
        let animation = null

        let lotteryNumber_1 = 0
        let lotteryNumber_2 = 0
        let lotteryNumber_3 = 0

        let stopFlag = new Array(0).fill(false)
        function onMouseDown() {
            const initial = document.getElementById('initial')
            const lottery = document.getElementById('lottery')

            initial.style.display = 'none'
            lottery.style.display = 'flex'

            run = !run

            if(run) {
                if(animation) {
                    cancelAnimationFrame(animation)
                }
                stopFlag = new Array(0).fill(false)
                curIndex = parseInt((Math.random() * numberArr.length * 100) % numberArr.length);
                let curNum = numberArr[curIndex];
                const str = curNum.toString().split('').map(i => parseInt(i))
                lotteryNumber_1 = str[0]
                lotteryNumber_2 = str[1]
                lotteryNumber_3 = str[2]
                startAnimation()
            } else {
                let data = JSON.parse(localStorage.getItem("luckynum"));
                if (data == null) {
                    data = [];
                }
                data.push(numberArr[curIndex]);
                idle = true;
                numberArr.splice(curIndex, 1);
                localStorage.setItem("luckynum", JSON.stringify(data));
                showlist();
                animation = null
            }

            
        }



        function rollup(serial, stopAt, elapsed) {  // serial = 1,2,3  elapsed Êó∂Èó¥Â∑Æ  stopAt ÊúÄÂêéÂÅúÂú®Âì™‰∏™Êï∞Â≠ó
            
            const list = document.getElementById('number-list-' + serial)
            const numberWindow = document.getElementById('number-window-' + serial)

            const elHeight = list.offsetHeight
            const windowHeight = numberWindow.offsetHeight
            const diff = list.offsetHeight - numberWindow.offsetHeight

            // ÊªöÂä®ÈÄüÂ∫¶
            let granularity = diff / (CYCLE_TIME*1000);
            if(!run) {
                granularity = diff / (SLOW_CYCLE*1000)
            }

            if(run) {
                if(Math.abs(list.offsetTop) > diff) {
                    const moveDiff = windowHeight - list.offsetTop - list.offsetHeight
                    setElementOffset(list, {y: 0})
                    loopNumberList(list)
                } else {
                    const move = Math.floor(granularity * elapsed)
                    const totalTop = -list.offsetTop + move
                    setElementOffset(list, {y: totalTop})
                }
            } else {
                if((parseInt(list.lastChild.innerHTML) !== stopAt)) {
                    loopNumberList(list, stopAt)
                }

                if(Math.abs(list.offsetTop) < diff) {
                    const move = Math.floor(granularity * elapsed)
                    const totalTop = -list.offsetTop + move
                    setElementOffset(list, {y: totalTop})
                } else {
                    stopFlag[serial] = true
                }
            }

        }

        function startAnimation() {
            let  previousTimeStamp;

            function step(timestamp) {
                if (previousTimeStamp === undefined) {
                    previousTimeStamp = timestamp;
                }

                if(previousTimeStamp !== timestamp) {
                    const elapsed = timestamp - previousTimeStamp;

                    rollup(1, lotteryNumber_1, elapsed)
                    rollup(2, lotteryNumber_2, elapsed)
                    rollup(3, lotteryNumber_3, elapsed)

                }

                previousTimeStamp = timestamp

                if(stopFlag.every(i => !!i)) {
                    animation = window.requestAnimationFrame(step)
                }
            }

            animation = window.requestAnimationFrame(step)
        }

        function buildNumberListDomByArray(array) {
            return array.reduce((prev, current) => {
                return prev + ('<div class="num">' + current + '</div>')
            }, '')
        }

        function reverseList(array) {
            const cloneArray = [...array]
            const last = cloneArray.pop()
            const reversed = [last, ...cloneArray]
            return reversed
        }

        function loopNumberList(el, last) {
            const listNodes = el.children
            const currentListArray = []
            for(let i = 0; i < listNodes.length; i++) {
                currentListArray.push(parseInt(listNodes.item(i).innerHTML))
            }

            let newArray
            if(last !== undefined) {
                const index = currentListArray.findIndex(n => n === last)
                const left = currentListArray.splice(0, index+1)
                newArray = [...currentListArray, ...left]
            } else {
                newArray = reverseList(currentListArray)
            }
            el.innerHTML = buildNumberListDomByArray(newArray)
        }
        

        showlist()
        function showlist() {
            let data = JSON.parse(localStorage.getItem("luckynum"));
            if (data == null) {
                data = [];
            }
            let innerHtml = '';
            data.forEach(element => {
                innerHtml += `NO.${element} üíó `
            });
            document.getElementById('list').innerHTML = innerHtml;
        }


        
    </script>
</body>

</html>